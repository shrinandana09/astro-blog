---
import Header from "../../components/header.astro";
import Footer from "../../components/Footer.astro";
import "../../styles/global.css";
import { getCollection, getEntryBySlug } from "astro:content";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return posts.map((post: any) => ({ params: { slug: post.slug } }));
}

// Use getEntryBySlug to fetch the current post based on the route slug.
// Call it via an `unknown` cast to avoid TypeScript 'never' issues in some environments.
const slug = (Astro.params as any).slug as string;
const post: any = await (getEntryBySlug as unknown as any)("blog", slug);
if (!post) {
  throw new Error("Post not found: " + slug);
}

// Compute formatted publish date
const pub = post.data.pubDate instanceof Date ? post.data.pubDate : new Date(post.data.pubDate);
const formattedDate = pub.toLocaleDateString("en-GB", { day: "numeric", month: "long", year: "numeric" });

// Estimate reading time (~200 words per minute)
const raw = (post.body ?? "") as string;
const words = raw.trim().split(/\s+/).filter(Boolean).length || 0;
const minutes = Math.max(1, Math.ceil(words / 200));
const readingTime = `${minutes} min read`;

const { Content } = await post.render();
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{post.data.title} | Astro Blog</title>
    <style>
      .post-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 50px 25px;
      }

      article {
        background: white;
        padding: 40px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      .post-header {
        margin-bottom: 40px;
        border-bottom: 3px solid #2563eb;
        padding-bottom: 25px;
      }

      .post-header h1 {
        font-size: 2.5rem;
        line-height: 1.2;
        color: #1a1a1a;
        margin: 0 0 15px 0;
        font-weight: 700;
      }

      .post-meta {
        display: flex;
        gap: 25px;
        font-size: 0.95rem;
        color: #666;
        flex-wrap: wrap;
      }

      .post-content {
        line-height: 1.8;
        color: #2d2d2d;
        font-size: 1.1rem;
      }

      .post-content h2 {
        margin-top: 40px;
        margin-bottom: 18px;
        font-size: 1.9rem;
        font-weight: 700;
        color: #1a1a1a;
        border-left: 5px solid #2563eb;
        padding-left: 18px;
        line-height: 1.3;
      }

      .post-content h3 {
        margin-top: 30px;
        margin-bottom: 14px;
        font-size: 1.35rem;
        font-weight: 600;
        color: #2563eb;
      }

      .post-content p {
        margin-bottom: 20px;
        letter-spacing: 0.3px;
      }

      .post-content p:first-of-type {
        font-size: 1.15rem;
        color: #444;
        font-weight: 500;
      }

      .post-content ul,
      .post-content ol {
        margin-bottom: 22px;
        margin-left: 32px;
      }

      .post-content li {
        margin-bottom: 12px;
        line-height: 1.7;
      }

      .post-content ul li::marker {
        color: #2563eb;
        font-weight: bold;
      }

      .post-content code {
        background: #f5f5f5;
        color: #d73a49;
        padding: 3px 8px;
        border-radius: 4px;
        font-family: "Courier New", monospace;
        font-size: 0.95em;
      }

      .post-content blockquote {
        border-left: 5px solid #2563eb;
        padding: 15px 20px;
        margin: 25px 0;
        background-color: #f0f4ff;
        border-radius: 0 8px 8px 0;
        font-style: italic;
        color: #555;
      }

      .post-content blockquote p {
        margin: 0;
      }

      .post-content hr {
        margin: 35px 0;
        border: none;
        border-top: 2px solid #e0e0e0;
      }

      .post-content a {
        color: #2563eb;
        text-decoration: none;
        border-bottom: 1px solid transparent;
        transition: all 0.2s ease;
      }

      .post-content a:hover {
        border-bottom: 1px solid #2563eb;
        color: #1e40af;
      }

      .back-link {
        display: inline-block;
        margin-bottom: 30px;
        color: #2563eb;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.2s ease;
        padding: 8px 0;
      }

      .back-link:hover {
        color: #1e40af;
        transform: translateX(-3px);
      }

      .back-link:before {
        content: "‚Üê ";
      }

      @media (max-width: 600px) {
        .post-container {
          padding: 30px 15px;
        }

        article {
          padding: 25px;
        }

        .post-header h1 {
          font-size: 1.8rem;
        }

        .post-content {
          font-size: 1rem;
        }

        .post-content h2 {
          font-size: 1.5rem;
        }

        .post-meta {
          flex-direction: column;
          gap: 8px;
        }
      }
    </style>
  </head>

  <body>
    <Header />

    <main class="container blog-content">
      <a href="/blog/" class="back-link">‚Üê Back to Blog</a>

      <article>
        <div class="post-header">
          <h1>{post.data.title}</h1>
          <div class="post-meta">
            <span>üìÖ {formattedDate}</span>
            <span>‚è±Ô∏è {readingTime}</span>
            {post.data.author && <span>‚úçÔ∏è {post.data.author}</span>}
          </div>
        </div>

        <div class="post-content">
          <Content />
        </div>
      </article>
    </main>

    <Footer />
  </body>
</html>
